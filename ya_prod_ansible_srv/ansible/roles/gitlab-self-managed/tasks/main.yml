---
# tasks for gitlab-self-managed role

# (access to repositories from the Russian Federation is prohibited)
# - name: Add GitLab Gitlab-SM repository
#   ansible.builtin.shell:
#     cmd: curl -L "https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh" | bash

- name: Install Gitlab-SM dependencies
  ansible.builtin.apt:
    pkg:
    - ca-certificates
    - tzdata
    - perl
    - postfix
    update_cache: yes

- name: Copy GitLab-SM from local directory 
  ansible.builtin.copy:
    src: files/gitlab-ee_15.9.1-ee.0_amd64.deb
    dest: /tmp/

- name: Install Gitlab-SM (public address generated by terraform into ansible hosts template)
  ansible.builtin.shell:
    cmd: EXTERNAL_URL="http://{{ my_public_address }}" dpkg -i /tmp/gitlab-ee_15.9.1-ee.0_amd64.deb

- name: Reconfigure Gitlab-SM
  ansible.builtin.shell:
    cmd: gitlab-ctl reconfigure

